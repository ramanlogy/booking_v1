<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Hotel Lumanti - Heritage & Modernity</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <!-- Library for QR Scanning -->
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #c9a961;
      --primary-dark: #a88b4d;
      --bg-black: #0a0a0a;
      --bg-card: #1a1a1a;
      --text-light: #f5f5f5;
      --text-muted: #b0b0b0;
      --border: #333;
      --success: #4caf50;
      --error: #ef4444;
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      -webkit-font-smoothing: antialiased;
    }

    body {
      font-family: 'Inter', sans-serif;
      background-color: var(--bg-black);
      color: var(--text-light);
      line-height: 1.6;
      min-height: 100vh;
      overflow-x: hidden;
    }

    .app-container {
      max-width: 500px;
      margin: 0 auto;
      padding: 20px;
    }

    .nav-switcher {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-bottom: 20px;
      border-bottom: 1px solid var(--border);
      padding-bottom: 10px;
    }

    .nav-btn {
      color: var(--text-muted);
      cursor: pointer;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 1.5px;
      font-weight: 600;
      padding: 5px 0;
      border-bottom: 2px solid transparent;
      transition: var(--transition);
    }

    .nav-btn.active {
      color: var(--primary);
      border-bottom-color: var(--primary);
    }

    header {
      text-align: center;
      padding: 20px 0 30px;
    }

    header h1 {
      font-family: 'Playfair Display', serif;
      font-size: 32px;
      color: var(--primary);
      letter-spacing: 2px;
      text-transform: uppercase;
    }

    header p {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 4px;
      color: var(--text-muted);
      margin-top: 5px;
    }

    /* Stepper UI */
    .stepper {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-bottom: 30px;
    }

    .step-node {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--border);
      transition: var(--transition);
    }

    .step-node.active {
      background: var(--primary);
      transform: scale(1.4);
      box-shadow: 0 0 12px var(--primary);
    }

    /* Views */
    .view {
      display: none;
      animation: fadeIn 0.4s ease-out;
    }

    .view.active {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    h2 {
      font-family: 'Playfair Display', serif;
      font-size: 20px;
      margin-bottom: 20px;
      color: var(--primary);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    h2::after {
      content: '';
      flex: 1;
      height: 1px;
      background: var(--border);
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      font-size: 11px;
      text-transform: uppercase;
      color: var(--text-muted);
      margin-bottom: 8px;
      font-weight: 700;
      letter-spacing: 1px;
    }

    input, select {
      width: 100%;
      padding: 14px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text-light);
      font-size: 15px;
      outline: none;
      transition: var(--transition);
    }

    input:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 1px var(--primary);
    }

    /* Stay Grid */
    .stay-grid {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 10px;
    }

    .stay-item {
      background: var(--bg-card);
      border: 1px solid var(--border);
      padding: 12px;
      border-radius: 10px;
      text-align: center;
      cursor: pointer;
      transition: var(--transition);
    }

    .stay-item.active {
      border-color: var(--primary);
      background: rgba(201, 169, 97, 0.1);
    }

    .stay-item h4 { font-size: 12px; color: var(--primary); margin-bottom: 4px; }
    .stay-item p { font-size: 10px; color: var(--text-muted); }

    /* Room Cards */
    .room-list {
      display: grid;
      gap: 15px;
    }

    .room-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
      cursor: pointer;
      transition: var(--transition);
      position: relative;
    }

    .room-card.disabled {
      opacity: 0.4;
      cursor: not-allowed;
      filter: grayscale(1);
    }

    .room-card.active {
      border-color: var(--primary);
      box-shadow: 0 0 0 2px var(--primary);
    }

    .room-img {
      width: 100%;
      height: 140px;
      object-fit: cover;
    }

    .room-info { padding: 15px; }
    .room-info h3 { font-size: 17px; color: var(--primary); }
    .room-info p { font-size: 12px; color: var(--text-muted); margin-top: 4px; }

    .price-tag {
      position: absolute;
      top: 10px;
      right: 10px;
      background: var(--primary);
      color: #000;
      padding: 4px 10px;
      border-radius: 20px;
      font-weight: 800;
      font-size: 11px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.5);
    }

    .avail-status {
      font-size: 10px;
      font-weight: 700;
      margin-top: 5px;
    }

    .avail-true { color: var(--success); }
    .avail-false { color: var(--error); }

    /* Buttons */
    .btn {
      width: 100%;
      padding: 16px;
      border-radius: 8px;
      border: none;
      font-weight: 700;
      cursor: pointer;
      font-size: 14px;
      transition: var(--transition);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .btn-gold { background: var(--primary); color: #000; }
    .btn-gold:hover:not(:disabled) { background: var(--primary-dark); }
    .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text-light); margin-top: 12px; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }

    /* Summary Card */
    .summary-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 20px;
    }

    .summary-row {
      display: flex;
      justify-content: space-between;
      font-size: 13px;
      margin-bottom: 8px;
    }

    .summary-total {
      border-top: 1px solid var(--border);
      margin-top: 10px;
      padding-top: 10px;
      font-weight: 700;
      color: var(--primary);
      font-size: 16px;
    }

    /* Ticket */
    .ticket-container {
      background: #fff;
      color: #000;
      border-radius: 15px;
      overflow: hidden;
      margin-top: 10px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.6);
    }

    .ticket-head {
      background: #000;
      color: var(--primary);
      padding: 20px;
      text-align: center;
    }

    .ticket-body {
      padding: 25px;
      text-align: center;
    }

    #qrcode-display {
      display: flex;
      justify-content: center;
      margin-bottom: 20px;
    }

    .ticket-grid {
      text-align: left;
      border-top: 1px dashed #ddd;
      padding-top: 15px;
    }

    .ticket-item {
      display: flex;
      justify-content: space-between;
      font-size: 13px;
      margin-bottom: 5px;
    }

    .ticket-label { color: #888; }
    .ticket-val { font-weight: 700; }

    /* Reception Mode */
    .reception-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 15px;
      padding: 25px;
    }

    #reception-scan-input {
      text-align: center;
      font-size: 20px;
      letter-spacing: 5px;
      font-family: monospace;
      padding: 15px;
      margin-bottom: 15px;
    }

    #reader {
      width: 100%;
      border-radius: 10px;
      overflow: hidden;
      margin-bottom: 15px;
      border: 1px solid var(--border);
      background: #000;
    }

    .guest-info-pane {
      margin-top: 20px;
      display: none;
      animation: fadeIn 0.3s;
    }

    .status-pill {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 800;
      text-transform: uppercase;
      background: #333;
    }

    .status-confirmed { color: var(--success); background: rgba(76, 175, 80, 0.1); }
    .status-checked-in { color: var(--primary); background: rgba(201, 169, 97, 0.1); }

    .loader {
      width: 18px;
      height: 18px;
      border: 2px solid rgba(255,255,255,0.2);
      border-top-color: #fff;
      border-radius: 50%;
      animation: spin 0.8s infinite linear;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    .error-toast {
      background: var(--error);
      color: #fff;
      padding: 10px;
      border-radius: 5px;
      font-size: 12px;
      margin-top: 10px;
      display: none;
    }

    #btn-start-scanner {
      margin-bottom: 15px;
    }
  </style>
</head>
<body>

<div class="app-container">
  <div class="nav-switcher">
    <div class="nav-btn active" id="btn-mode-booking">Guest Booking</div>
    <div class="nav-btn" id="btn-mode-reception">Reception Terminal</div>
  </div>

  <header>
    <h1>Lumanti</h1>
    <p>Heritage Hospitality</p>
  </header>

  <!-- GUEST BOOKING FLOW -->
  <div id="booking-section">
    <div class="stepper">
      <div class="step-node active" data-step="1"></div>
      <div class="step-node" data-step="2"></div>
      <div class="step-node" data-step="3"></div>
      <div class="step-node" data-step="4"></div>
    </div>

    <!-- Step 1: When & What Type -->
    <div class="view active" id="view-step-1">
      <h2>1. Stay Details</h2>
      <div class="form-group">
        <label>Category</label>
        <div class="stay-grid">
          <div class="stay-item active" data-stay="Daycation" data-start="11:00" data-end="17:00">
            <h4>Daycation</h4>
            <p>11AM - 5PM</p>
          </div>
          <div class="stay-item" data-stay="Staycation" data-start="19:00" data-end="23:59">
            <h4>Staycation</h4>
            <p>7PM Onwards</p>
          </div>
          <div class="stay-item" data-stay="Full Stay" data-start="11:00" data-end="23:59">
            <h4>Full Stay</h4>
            <p>24h Stay</p>
          </div>
        </div>
      </div>

      <div class="form-group">
        <label>Reservation Date</label>
        <input type="date" id="input-date">
      </div>

      <div class="form-group">
        <label>Expected Arrival Time</label>
        <input type="time" id="input-time">
        <div class="error-toast" id="time-error">Arrival time must be within stay window.</div>
      </div>

      <button class="btn btn-gold" id="btn-to-step-2">
        <span id="txt-check-avail">Check Availability</span>
        <div class="loader" id="loader-check-avail" style="display:none;"></div>
      </button>
    </div>

    <!-- Step 2: Room Selection -->
    <div class="view" id="view-step-2">
      <h2>2. Select Your Room</h2>
      <div class="room-list" id="room-list-container">
        <!-- Rendered via JS -->
      </div>
      <button class="btn btn-outline" onclick="changeStep(1)">Back</button>
      <button class="btn btn-gold" id="btn-to-step-3" disabled style="margin-top:15px;">Continue to Details</button>
    </div>

    <!-- Step 3: Guest Details -->
    <div class="view" id="view-step-3">
      <h2>3. Guest Details</h2>
      <div class="form-group">
        <label>Full Name</label>
        <input type="text" id="input-name" placeholder="As per Identity Document">
      </div>
      <div class="form-group">
        <label>Phone Number</label>
        <input type="tel" id="input-phone" placeholder="98XXXXXXXX">
      </div>

      <div class="summary-card">
        <label>Booking Summary</label>
        <div class="summary-row"><span>Stay:</span> <span id="summ-stay">-</span></div>
        <div class="summary-row"><span>Date:</span> <span id="summ-date">-</span></div>
        <div class="summary-row"><span>Room:</span> <span id="summ-room">-</span></div>
        <div class="summary-row"><span>Rate:</span> <span id="summ-rate">-</span></div>
        <div class="summary-total summary-row">
          <span>Total (2 Persons Minimum):</span>
          <span id="summ-total">-</span>
        </div>
      </div>

      <button class="btn btn-outline" onclick="changeStep(2)">Back</button>
      <button class="btn btn-gold" id="btn-confirm-booking" style="margin-top:15px;">Confirm & Book Now</button>
    </div>

    <!-- Step 4: Success Ticket -->
    <div class="view" id="view-step-4">
      <div style="text-align:center; margin-bottom: 20px;">
        <h2 style="border:none; padding:0; display:inline-block;">Success!</h2>
        <p style="color:var(--success); font-weight:600; font-size: 13px;">Your reservation is confirmed.</p>
      </div>

      <div id="capture-ticket" class="ticket-container">
        <div class="ticket-head">LUMANTI HERITAGE</div>
        <div class="ticket-body">
          <div id="qrcode-display"></div>
          <div class="ticket-grid" id="ticket-data-grid">
            <!-- Rendered via JS -->
          </div>
          <p style="font-size:10px; color:#999; margin-top:20px; font-weight:700;">#<span id="ticket-ref-id"></span></p>
        </div>
      </div>

      <button class="btn btn-gold" id="btn-download-ticket" style="margin-top: 25px;">Download Digital Ticket</button>
      <button class="btn btn-outline" onclick="location.reload()">New Reservation</button>
    </div>
  </div>

  <!-- RECEPTION MODE -->
  <div id="reception-section" style="display:none;">
    <div class="reception-card">
      <div class="form-group" style="text-align:center;">
        <label>Reception Terminal: Scan QR Code</label>
        
        <!-- Scanner Area -->
        <div id="reader"></div>
        <button class="btn btn-gold" id="btn-start-scanner">Open Scanner</button>

        <label>Or Enter Token Manually</label>
        <input type="text" id="reception-scan-input" placeholder="LMT-XXXXXX" autocomplete="off">
        <div class="error-toast" id="scan-error">Invalid or missing token.</div>
      </div>

      <div class="guest-info-pane" id="guest-preview-pane">
        <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom: 15px;">
          <div>
            <h3 id="prev-guest-name" style="color:var(--primary);">-</h3>
            <p id="prev-guest-ref" style="font-size:11px; color:var(--text-muted);">-</p>
          </div>
          <div id="prev-guest-status" class="status-pill">-</div>
        </div>

        <div style="background:var(--bg-black); padding:15px; border-radius:10px; border:1px solid var(--border); margin-bottom:15px;">
          <div class="summary-row"><span>Category</span><span id="prev-stay-type">-</span></div>
          <div class="summary-row"><span>Room</span><span id="prev-room-type">-</span></div>
          <div class="summary-row"><span>Scheduled</span><span id="prev-checkin-time">-</span></div>
          <div class="summary-row"><span>Phone</span><span id="prev-phone">-</span></div>
          <div class="summary-row summary-total"><span>Amount Due</span><span id="prev-amount">-</span></div>
        </div>

        <button class="btn btn-gold" id="btn-reception-checkin">Confirm Check-In</button>
      </div>
    </div>
  </div>
</div>

<script>
  const CONFIG = {
    URL: 'https://fzwnglhxtmtltpysdzma.supabase.co/rest/v1/bookings',
    KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ6d25nbGh4dG10bHRweXNkem1hIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2ODU4MTQzMCwiZXhwIjoyMDg0MTU3NDMwfQ.Ok0ZxnIHJnsvM2D67BiNoe84VnCqaV_Tz61Zl73nuRw'
  };

  const ROOMS = [
    { id: 'mini', name: 'Mini Heritage', cap: 4, basePrice: 499, img: 'https://images.unsplash.com/photo-1596394516093-501ba68a0ba6?w=500', desc: 'Cozy room with cultural charm.' },
    { id: 'deluxe', name: 'Deluxe Boutique', cap: 3, basePrice: 549, img: 'https://images.unsplash.com/photo-1566665797739-1674de7a421a?w=500', desc: 'Modern amenities with poetic fan-cooled breeze.' },
    { id: 'classic', name: 'Classic Temple View', cap: 2, basePrice: 599, img: 'https://images.unsplash.com/photo-1590490360182-c33d57733427?w=500', desc: 'Large windows overlooking the heritage temple.' },
    { id: 'suite', name: 'Royal Suite (AC)', cap: 2, basePrice: 749, img: 'https://images.unsplash.com/photo-1582719478250-c89cae4dc85b?w=500', desc: 'Premium AC comfort with a private balcony.' }
  ];

  let state = {
    step: 1,
    mode: 'booking',
    stayType: 'Daycation',
    date: new Date().toISOString().split('T')[0],
    time: '12:00',
    selectedRoom: null,
    availabilities: {}
  };

  let html5QrCode = null;

  // Setup Defaults
  document.getElementById('input-date').value = state.date;
  document.getElementById('input-date').min = state.date;
  document.getElementById('input-time').value = state.time;

  // Nav Switcher
  document.getElementById('btn-mode-booking').onclick = () => switchMode('booking');
  document.getElementById('btn-mode-reception').onclick = () => switchMode('reception');

  function switchMode(mode) {
    state.mode = mode;
    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
    document.getElementById(`btn-mode-${mode}`).classList.add('active');
    document.getElementById('booking-section').style.display = mode === 'booking' ? 'block' : 'none';
    document.getElementById('reception-section').style.display = mode === 'reception' ? 'block' : 'none';
    if(mode === 'reception') {
      document.getElementById('reception-scan-input').focus();
    } else {
      stopScanner();
    }
  }

  // Scanner Logic
  const startScanner = async () => {
    html5QrCode = new Html5Qrcode("reader");
    const config = { fps: 10, qrbox: { width: 250, height: 250 } };
    
    document.getElementById('btn-start-scanner').style.display = 'none';
    document.getElementById('reader').style.display = 'block';

    try {
      await html5QrCode.start(
        { facingMode: "environment" },
        config,
        (decodedText) => {
          // On Success
          document.getElementById('reception-scan-input').value = decodedText;
          lookupBooking(decodedText);
          stopScanner();
        },
        (errorMessage) => {
          // console.log("Scanning...");
        }
      );
    } catch (err) {
      alert("Error accessing camera: " + err);
      document.getElementById('btn-start-scanner').style.display = 'block';
    }
  };

  const stopScanner = () => {
    if (html5QrCode && html5QrCode.isScanning) {
      html5QrCode.stop().then(() => {
        document.getElementById('reader').style.display = 'none';
        document.getElementById('btn-start-scanner').style.display = 'block';
      });
    }
  };

  document.getElementById('btn-start-scanner').onclick = startScanner;

  // Lookup Logic
  const lookupBooking = async (token) => {
    try {
      const resp = await fetch(`${CONFIG.URL}?qr_token=eq.${token}`, {
        headers: { apikey: CONFIG.KEY, Authorization: `Bearer ${CONFIG.KEY}` }
      });
      const data = await resp.json();
      
      if(data && data.length > 0) {
        showGuestPreview(data[0]);
        document.getElementById('scan-error').style.display = 'none';
      } else {
        document.getElementById('scan-error').style.display = 'block';
        document.getElementById('guest-preview-pane').style.display = 'none';
      }
    } catch(e) { console.error(e); }
  };

  // Step 1: Category Logic
  document.querySelectorAll('.stay-item').forEach(item => {
    item.onclick = () => {
      document.querySelectorAll('.stay-item').forEach(i => i.classList.remove('active'));
      item.classList.add('active');
      state.stayType = item.dataset.stay;
      
      const timeInput = document.getElementById('input-time');
      if(timeInput.value < item.dataset.start || timeInput.value > item.dataset.end) {
        timeInput.value = item.dataset.start;
      }
      validateTime();
    };
  });

  const validateTime = () => {
    const t = document.getElementById('input-time').value;
    const active = document.querySelector('.stay-item.active');
    const start = active.dataset.start;
    const end = active.dataset.end;
    const isValid = t >= start && t <= end;
    document.getElementById('time-error').style.display = isValid ? 'none' : 'block';
    state.time = t;
    return isValid;
  };

  document.getElementById('input-time').oninput = validateTime;
  document.getElementById('input-date').onchange = (e) => state.date = e.target.value;

  // Step Change Function
  function changeStep(n) {
    state.step = n;
    document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
    document.querySelectorAll('.step-node').forEach(s => s.classList.remove('active'));
    document.getElementById(`view-step-${n}`).classList.add('active');
    for(let i=1; i<=n; i++) document.querySelector(`.step-node[data-step="${i}"]`).classList.add('active');
    window.scrollTo(0, 0);
  }

  // Step 1 -> 2
  document.getElementById('btn-to-step-2').onclick = async () => {
    if(!validateTime()) return;

    const btn = document.getElementById('btn-to-step-2');
    const txt = document.getElementById('txt-check-avail');
    const ldr = document.getElementById('loader-check-avail');

    btn.disabled = true;
    txt.style.display = 'none';
    ldr.style.display = 'block';

    try {
      const resp = await fetch(`${CONFIG.URL}?check_in_date=eq.${state.date}&stay_type=eq.${state.stayType}`, {
        headers: { apikey: CONFIG.KEY, Authorization: `Bearer ${CONFIG.KEY}` }
      });
      const data = await resp.json();
      
      state.availabilities = {};
      ROOMS.forEach(r => {
        const bookedCount = data.filter(b => b.room_type === r.name).length;
        state.availabilities[r.name] = Math.max(0, r.cap - bookedCount);
      });

      renderRoomList();
      changeStep(2);
    } catch (e) {
      alert("Error checking availability. Check connection.");
    } finally {
      btn.disabled = false;
      txt.style.display = 'inline';
      ldr.style.display = 'none';
    }
  };

  const getPriceMultiplier = (stay) => {
    if (stay === 'Staycation') return 1.4;
    if (stay === 'Full Stay') return 2.4;
    return 1;
  };

  function renderRoomList() {
    const container = document.getElementById('room-list-container');
    container.innerHTML = '';
    
    const multiplier = getPriceMultiplier(state.stayType);

    ROOMS.forEach(room => {
      const availCount = state.availabilities[room.name];
      const isFull = availCount <= 0;
      const personPrice = Math.round(room.basePrice * multiplier);

      const card = document.createElement('div');
      card.className = `room-card ${isFull ? 'disabled' : ''}`;
      card.innerHTML = `
        <img src="${room.img}" class="room-img" alt="${room.name}">
        <div class="price-tag">Rs ${personPrice} / person</div>
        <div class="room-info">
          <h3>${room.name}</h3>
          <p>${room.desc}</p>
          <div class="avail-status ${isFull ? 'avail-false' : 'avail-true'}">
            ${isFull ? 'Sold Out' : availCount + ' Rooms Available'}
          </div>
        </div>
      `;

      if(!isFull) {
        card.onclick = () => {
          document.querySelectorAll('.room-card').forEach(c => c.classList.remove('active'));
          card.classList.add('active');
          state.selectedRoom = { ...room, currentPrice: personPrice };
          document.getElementById('btn-to-step-3').disabled = false;
        };
      }
      container.appendChild(card);
    });
  }

  // Step 2 -> 3
  document.getElementById('btn-to-step-3').onclick = () => {
    const total = state.selectedRoom.currentPrice * 2;
    document.getElementById('summ-stay').innerText = state.stayType;
    document.getElementById('summ-date').innerText = state.date + ' @ ' + state.time;
    document.getElementById('summ-room').innerText = state.selectedRoom.name;
    document.getElementById('summ-rate').innerText = 'Rs ' + state.selectedRoom.currentPrice + ' / person';
    document.getElementById('summ-total').innerText = 'Rs ' + total;
    changeStep(3);
  };

  // Step 3 -> 4 (Confirm)
  document.getElementById('btn-confirm-booking').onclick = async () => {
    const name = document.getElementById('input-name').value.trim();
    const phone = document.getElementById('input-phone').value.trim();

    if(!name || phone.length < 10) return alert("Please enter valid full name and phone number.");

    const btn = document.getElementById('btn-confirm-booking');
    btn.disabled = true;
    btn.innerHTML = '<div class="loader"></div> Finalizing...';

    const refToken = 'LMT-' + Math.random().toString(36).substr(2, 6).toUpperCase();
    const payload = {
      full_name: name,
      phone_number: phone,
      check_in_date: state.date,
      arrival_time: state.time,
      stay_type: state.stayType,
      room_type: state.selectedRoom.name,
      total_amount: state.selectedRoom.currentPrice * 2,
      status: 'confirmed',
      qr_token: refToken
    };

    try {
      const resp = await fetch(CONFIG.URL, {
        method: 'POST',
        headers: { 
          'apikey': CONFIG.KEY, 'Authorization': `Bearer ${CONFIG.KEY}`, 
          'Content-Type': 'application/json', 'Prefer': 'return=representation' 
        },
        body: JSON.stringify(payload)
      });
      const data = await resp.json();
      const confirmed = data[0];

      // Build Ticket
      document.getElementById('ticket-ref-id').innerText = confirmed.qr_token;
      document.getElementById('ticket-data-grid').innerHTML = `
        <div class="ticket-item"><span class="ticket-label">Guest</span><span class="ticket-val">${confirmed.full_name}</span></div>
        <div class="ticket-item"><span class="ticket-label">Room</span><span class="ticket-val">${confirmed.room_type}</span></div>
        <div class="ticket-item"><span class="ticket-label">Category</span><span class="ticket-val">${confirmed.stay_type}</span></div>
        <div class="ticket-item"><span class="ticket-label">Schedule</span><span class="ticket-val">${confirmed.check_in_date} @ ${confirmed.arrival_time}</span></div>
        <div class="ticket-item" style="margin-top:10px; border-top:1px dashed #ddd; padding-top:10px;">
          <span class="ticket-label">Total Payable</span>
          <span class="ticket-val" style="color:var(--primary-dark); font-size:16px;">Rs ${confirmed.total_amount}</span>
        </div>
      `;

      // QR Code
      const qrTarget = document.getElementById('qrcode-display');
      qrTarget.innerHTML = '';
      setTimeout(() => {
        new QRCode(qrTarget, {
          text: confirmed.qr_token,
          width: 150,
          height: 150,
          colorDark: "#000000",
          colorLight: "#ffffff",
          correctLevel: QRCode.CorrectLevel.H
        });
      }, 100);

      changeStep(4);
    } catch (e) {
      alert("Booking failed. Please try again.");
      btn.disabled = false;
      btn.innerHTML = 'Confirm & Book Now';
    }
  };

  // Ticket Capture
  document.getElementById('btn-download-ticket').onclick = () => {
    html2canvas(document.getElementById('capture-ticket'), { scale: 3 }).then(canvas => {
      const a = document.createElement('a');
      a.download = `Lumanti-Booking-${document.getElementById('ticket-ref-id').innerText}.png`;
      a.href = canvas.toDataURL();
      a.click();
    });
  };

  // RECEPTION LOGIC
  const scanInput = document.getElementById('reception-scan-input');
  let scannedBooking = null;

  scanInput.oninput = async (e) => {
    const val = e.target.value.trim();
    if(val.length < 8) {
      document.getElementById('guest-preview-pane').style.display = 'none';
      return;
    }
    lookupBooking(val);
  };

  function showGuestPreview(b) {
    document.getElementById('prev-guest-name').innerText = b.full_name;
    document.getElementById('prev-guest-ref').innerText = 'Ref: ' + b.qr_token;
    document.getElementById('prev-stay-type').innerText = b.stay_type;
    document.getElementById('prev-room-type').innerText = b.room_type;
    document.getElementById('prev-checkin-time').innerText = b.check_in_date + ' @ ' + b.arrival_time;
    document.getElementById('prev-phone').innerText = b.phone_number;
    document.getElementById('prev-amount').innerText = 'Rs ' + b.total_amount;
    
    const status = document.getElementById('prev-guest-status');
    status.innerText = b.status.replace('_', ' ');
    status.className = `status-pill status-${b.status.replace('_', '-')}`;

    const checkInBtn = document.getElementById('btn-reception-checkin');
    if(b.status === 'checked_in') {
      checkInBtn.disabled = true;
      checkInBtn.innerText = 'Guest Already Checked In';
    } else {
      checkInBtn.disabled = false;
      checkInBtn.innerText = 'Confirm Check-In';
    }

    document.getElementById('guest-preview-pane').style.display = 'block';
  }

  document.getElementById('btn-reception-checkin').onclick = async () => {
    if(!scannedBooking) return;
    const btn = document.getElementById('btn-reception-checkin');
    btn.disabled = true;
    btn.innerText = 'Updating...';

    try {
      const resp = await fetch(`${CONFIG.URL}?id=eq.${scannedBooking.id}`, {
        method: 'PATCH',
        headers: { 
          'apikey': CONFIG.KEY, 'Authorization': `Bearer ${CONFIG.KEY}`, 
          'Content-Type': 'application/json', 'Prefer': 'return=representation' 
        },
        body: JSON.stringify({ status: 'checked_in' })
      });
      const data = await resp.json();
      showGuestPreview(data[0]);
      alert("Check-in successful!");
      scanInput.value = '';
    } catch(e) {
      alert("Error updating check-in status.");
      btn.disabled = false;
      btn.innerText = 'Confirm Check-In';
    }
  };
</script>

</body>
</html>
